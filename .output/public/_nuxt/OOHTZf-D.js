import{e as H,s as w,r as $,v as D,a5 as N,c as q,a as o,b as u,w as V,t as G,z as J,a2 as x,a0 as K,a6 as Q,a7 as Z,P as ee,o as te,d as E,a8 as oe}from"./BjynnqB9.js";import{_ as le}from"./DlAUqK2U.js";const ne=globalThis.setInterval,ae={style:{padding:"16px","max-width":"900px",margin:"0 auto"}},se={style:{display:"flex",gap:"12px","align-items":"center","margin-bottom":"12px"}},ie={style:{display:"flex",gap:"16px","flex-wrap":"wrap"}},de={style:{flex:"1","min-width":"260px"}},re={style:{background:"#fff",padding:"12px","border-radius":"8px"}},ue={style:{"margin-bottom":"8px"}},me={style:{display:"flex",gap:"8px","margin-top":"8px"}},pe={style:{flex:"1"}},ve={style:{flex:"1"}},fe={style:{display:"flex",gap:"8px","margin-top":"8px"}},ce={style:{flex:"1"}},ge={style:{flex:"1"}},ye={style:{display:"flex",gap:"8px","margin-top":"8px"}},we={style:{flex:"1"}},xe={style:{display:"flex",gap:"8px","margin-top":"8px"}},he={style:{flex:"1"}},be={style:{flex:"1"}},Ve={style:{"margin-top":"12px"}},_e={style:{flex:"1","min-width":"300px"}},ke={style:{background:"#fff",padding:"12px","border-radius":"8px"}},Ue={style:{width:"100%",display:"flex","justify-content":"center"}},Se={style:{width:"360px",height:"360px","border-radius":"24px",overflow:"hidden",background:"#111",display:"flex","align-items":"center","justify-content":"center"}},Ee=["src"],Re="/image/proto/default1.png",Me="/image/background/magazine.jpg",Te=H({__name:"index",setup(Le){const P=w(null),f=w(""),i=w(null),v=w(null),_=w(null),n=$({outputSize:1080,screen:{left:.06,top:.06,width:.88,height:.88},scale:1,offsetX:0,offsetY:0,fps:25,duration:0,blurAmount:18});let c=null;const R=w(!1),A=t=>{if(!t||!t.type.startsWith("video/")){x.error("请上传视频文件 (MP4/MOV 等)");return}P.value=t,f.value&&URL.revokeObjectURL(f.value),f.value=URL.createObjectURL(t),i.value&&(i.value.src=f.value,i.value.load(),i.value.addEventListener("loadedmetadata",async()=>{console.log("video loadedmetadata",i.value?.videoWidth,i.value?.videoHeight,i.value?.duration),x.info("视频已加载元数据"),await j()},{once:!0}),i.value.addEventListener("error",e=>{console.error("video error",e),x.error("视频加载出错，浏览器可能不支持该编码或存在 CORS 限制")}))},j=async()=>{if(!i.value||!v.value)return;const t=i.value;try{await new Promise(s=>{t.readyState>=2?s():t.addEventListener("loadedmetadata",()=>s(),{once:!0})}),t.currentTime=0,await new Promise(s=>t.addEventListener("seeked",()=>s(),{once:!0}));const e=v.value,l=e.getContext("2d");if(!l)return;M(e),k(l),((t.videoWidth||0)===0||(t.videoHeight||0)===0)&&(await new Promise(s=>setTimeout(s,200)),k(l))}catch{}},M=t=>{const e=n.outputSize,l=window&&window.devicePixelRatio?window.devicePixelRatio:1;t.style.width=`${e}px`,t.style.height=`${e}px`,t.width=Math.round(e*l),t.height=Math.round(e*l)},k=t=>{if(!v.value)return;const e=v.value,l=e.width,s=e.height;t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,l,s);const r=new Image;r.src=Me,r.onload=()=>{t.save(),t.filter=`blur(${n.blurAmount}px)`;const m=r.naturalWidth,d=r.naturalHeight,a=Math.max(l/m,s/d),h=m*a,U=d*a;t.drawImage(r,(l-h)/2,(s-U)/2,h,U),t.restore();const S=Math.round(n.screen.left*l),b=Math.round(n.screen.top*s),g=Math.round(n.screen.width*l),p=Math.round(n.screen.height*s);if(t.fillStyle="#000",O(t,S,b,g,p,Math.round(l*.05)),t.fill(),i.value&&i.value.readyState>=2){const y=i.value,T=y.videoWidth,L=y.videoHeight,C=Math.max(g/T,p/L)*n.scale,I=T*C,z=L*C,X=S+(g-I)/2+n.offsetX,Y=b+(p-z)/2+n.offsetY;try{t.drawImage(y,0,0,T,L,X,Y,I,z)}catch{}}if(_.value&&_.value.complete)try{t.drawImage(_.value,0,0,l,s)}catch{}}},O=(t,e,l,s,r,m)=>{t.beginPath(),t.moveTo(e+m,l),t.arcTo(e+s,l,e+s,l+r,m),t.arcTo(e+s,l+r,e,l+r,m),t.arcTo(e,l+r,e,l,m),t.arcTo(e,l,e+s,l,m),t.closePath()},F=async()=>{if(!i.value||!v.value)return;try{await i.value.play()}catch{}const t=v.value,e=t.getContext("2d");if(!e)return;M(t);const l=()=>{k(e),c=requestAnimationFrame(l)};c=requestAnimationFrame(l)},B=()=>{i.value&&(i.value.pause(),i.value.currentTime=0),c&&(cancelAnimationFrame(c),c=null)},W=async()=>{if(!P.value||!i.value||!v.value){x.error("请先上传视频");return}processing.value=!0;try{const t=v.value,e=t.getContext("2d");if(!e)throw new Error("Canvas not supported");M(t);const l=t.captureStream(n.fps),s=[],r=MediaRecorder.isTypeSupported("video/webm;codecs=vp9")?"video/webm;codecs=vp9":"video/webm",m=new MediaRecorder(l,{mimeType:r});m.ondataavailable=p=>{p.data&&p.data.size&&s.push(p.data)},m.start(100);const d=i.value;d.currentTime=0,d.muted=!0,await d.play().catch(()=>{});const a=1e3/Math.max(1,n.fps);let h=0;const U=n.duration>0?n.duration:d.duration||3;await new Promise(p=>{const y=ne(()=>{k(e),h+=a/1e3,(h>=U||d.ended)&&(clearInterval(y),p())},a)}),m.stop(),await new Promise(p=>m.addEventListener("stop",()=>p(),{once:!0}));const S=new Blob(s,{type:r}),b=URL.createObjectURL(S),g=document.createElement("a");g.href=b,g.download=`mockup-1to1-${Date.now()}.webm`,g.click(),setTimeout(()=>URL.revokeObjectURL(b),200),x.success("导出完成"),d.pause(),d.currentTime=0}catch(t){console.error(t),x.error("导出失败："+(t?.message||t))}finally{processing.value=!1}};return D(()=>{const t=new Image;t.src=Re,t.onload=()=>{_.value=t}}),N(()=>{c&&cancelAnimationFrame(c),f.value&&URL.revokeObjectURL(f.value)}),(t,e)=>{const l=K,s=Q,r=oe,m=Z,d=ee;return te(),q("div",ae,[o("div",se,[o("input",{type:"file",accept:"video/*",onChange:e[0]||(e[0]=a=>A(a.target.files?.[0]))},null,32),u(l,{type:"primary",loading:t.processing,onClick:W},{default:V(()=>[...e[11]||(e[11]=[E("导出 1:1 展示视频",-1)])]),_:1},8,["loading"]),u(l,{onClick:F},{default:V(()=>[...e[12]||(e[12]=[E("播放预览",-1)])]),_:1}),u(l,{onClick:B},{default:V(()=>[...e[13]||(e[13]=[E("停止",-1)])]),_:1}),u(s,{modelValue:R.value,"onUpdate:modelValue":e[1]||(e[1]=a=>R.value=a),style:{"margin-left":"12px"}},{default:V(()=>[...e[14]||(e[14]=[E("显示 video 元素（调试）",-1)])]),_:1},8,["modelValue"])]),o("div",ie,[o("div",de,[o("div",re,[e[23]||(e[23]=o("div",{style:{"font-weight":"600","margin-bottom":"8px"}},"设置",-1)),o("div",ue,"输出尺寸："+G(n.outputSize)+"px (1:1)",1),u(m,{modelValue:n.outputSize,"onUpdate:modelValue":e[2]||(e[2]=a=>n.outputSize=a),style:{width:"160px"}},{default:V(()=>[u(r,{value:540,label:"540"}),u(r,{value:720,label:"720"}),u(r,{value:1080,label:"1080"})]),_:1},8,["modelValue"]),e[24]||(e[24]=o("div",{style:{"margin-top":"12px"}},"屏幕区域（百分比）",-1)),o("div",me,[o("div",pe,[e[15]||(e[15]=o("div",null,"left",-1)),u(d,{modelValue:n.screen.left,"onUpdate:modelValue":e[3]||(e[3]=a=>n.screen.left=a),min:0,max:.4,step:.01},null,8,["modelValue"])]),o("div",ve,[e[16]||(e[16]=o("div",null,"top",-1)),u(d,{modelValue:n.screen.top,"onUpdate:modelValue":e[4]||(e[4]=a=>n.screen.top=a),min:0,max:.4,step:.01},null,8,["modelValue"])])]),o("div",fe,[o("div",ce,[e[17]||(e[17]=o("div",null,"width",-1)),u(d,{modelValue:n.screen.width,"onUpdate:modelValue":e[5]||(e[5]=a=>n.screen.width=a),min:.5,max:.95,step:.01},null,8,["modelValue"])]),o("div",ge,[e[18]||(e[18]=o("div",null,"height",-1)),u(d,{modelValue:n.screen.height,"onUpdate:modelValue":e[6]||(e[6]=a=>n.screen.height=a),min:.5,max:.95,step:.01},null,8,["modelValue"])])]),e[25]||(e[25]=o("div",{style:{"margin-top":"12px"}},"视频缩放与位移",-1)),o("div",ye,[o("div",we,[e[19]||(e[19]=o("div",null,"缩放",-1)),u(d,{modelValue:n.scale,"onUpdate:modelValue":e[7]||(e[7]=a=>n.scale=a),min:.5,max:2,step:.01},null,8,["modelValue"])])]),o("div",xe,[o("div",he,[e[20]||(e[20]=o("div",null,"offsetX",-1)),u(d,{modelValue:n.offsetX,"onUpdate:modelValue":e[8]||(e[8]=a=>n.offsetX=a),min:-500,max:500},null,8,["modelValue"])]),o("div",be,[e[21]||(e[21]=o("div",null,"offsetY",-1)),u(d,{modelValue:n.offsetY,"onUpdate:modelValue":e[9]||(e[9]=a=>n.offsetY=a),min:-500,max:500},null,8,["modelValue"])])]),o("div",Ve,[e[22]||(e[22]=o("div",null,"模糊背景强度",-1)),u(d,{modelValue:n.blurAmount,"onUpdate:modelValue":e[10]||(e[10]=a=>n.blurAmount=a),min:0,max:40},null,8,["modelValue"])])])]),o("div",_e,[o("div",ke,[e[26]||(e[26]=o("div",{style:{"font-weight":"600","margin-bottom":"8px"}},"预览 (1:1)",-1)),o("div",Ue,[o("div",Se,[o("canvas",{ref_key:"canvasEl",ref:v,style:{width:"100%",height:"100%",display:"block"}},null,512),o("video",{ref_key:"videoEl",ref:i,src:f.value,style:J({display:R.value?"block":"none",width:"100%"}),controls:""},null,12,Ee)])])])])])])}}}),ze=le(Te,[["__scopeId","data-v-ae2fa0ca"]]);export{ze as default};
